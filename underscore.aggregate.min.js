/* 
underscore.aggregate#1.0.0 
Copyright (C) Nicolas Panel 2014 
MIT license 
*/ 
"use strict";(function(){var a=function(b,c){if(_.isString(b)&&"$"===b.charAt(0)){var d=b.substring(1);return""===d?c:_(d.split(".")).reduce(function(a,b){return a[b]},c)}if(_.isObject(b)){if(_.has(b,"$fn"))return b.$fn(c);if(_.has(b,"$literal"))return b.$literal;if(_.has(b,"$add"))return _(b.$add).reduce(function(b,d){return b+a(d,c)},0);if(_.has(b,"$divide"))return a(b.$divide[0],c)/a(b.$divide[1],c);if(_.has(b,"$mod"))return a(b.$mod[0],c)%a(b.$mod[1],c);if(_.has(b,"$multiply"))return _(b.$multiply).reduce(function(b,d){return b*a(d,c)},1);if(_.has(b,"$subtract"))return a(b.$subtract[0],c)-a(b.$subtract[1],c);if(_.has(b,"$eq"))return a(b.$eq[0],c)===a(b.$eq[1],c);if(_.has(b,"$ne"))return a(b.$ne[0],c)!==a(b.$ne[1],c);if(_.has(b,"$gt"))return a(b.$gt[0],c)>a(b.$gt[1],c);if(_.has(b,"$gte"))return a(b.$gte[0],c)>=a(b.$gte[1],c);if(_.has(b,"$lt"))return a(b.$lt[0],c)<a(b.$lt[1],c);if(_.has(b,"$lte"))return a(b.$lte[0],c)<=a(b.$lte[1],c);if(_.has(b,"$and"))return _(b.$and).every(function(b){return a(b,c)});if(_.has(b,"$or"))return _(b.$or).some(function(b){return a(b,c)});if(_.has(b,"$not"))return!a(b.$not,c);if(_.has(b,"$substr")){var e=a(b.$substr[0],c),g=a(b.$substr[1],c),h=a(b.$substr[2],c);return e.substr(g,h)}if(_.has(b,"$toLower"))return a(b.$toLower,c).toLowerCase();if(_.has(b,"$toUpper"))return a(b.$toUpper,c).toUpperCase();if(_.has(b,"$size"))return a(b.$size,c).length;if(_.has(b,"$dayOfMonth"))return a(b.$dayOfMonth,c).date();if(_.has(b,"$dayOfWeek"))return a(b.$dayOfWeek,c).weekday();if(_.has(b,"$dayOfYear"))return a(b.$dayOfYear,c).dayOfYear();if(_.has(b,"$hour"))return a(b.$hour,c).hour();if(_.has(b,"$millisecond"))return a(b.$millisecond,c).millisecond();if(_.has(b,"$minute"))return a(b.$minute,c).minute();if(_.has(b,"$month"))return a(b.$month,c).month();if(_.has(b,"$second"))return a(b.$second,c).second();if(_.has(b,"$week"))return a(b.$week,c).week();if(_.has(b,"$year"))return a(b.$year,c).year();if(_.has(b,"$format")){var i=_.isArray(b.$format)?_(b.$format).map(function(b){return a(b,c)}):a(b.$format,c);return _.isString(i)?f.apply(i,[c]):1===i.length&&_.isString(i[0])?f.apply(i[0],[c]):_.isString(i[0])?f.apply(i[0],_.rest(i,1)):i[0].format(i[1])}return _.has(b,"$parse")?moment(a(b.$parse,c)):b}return b},b=function(b,c,d){var e=_(c.split(".")).reduce(function(a,c){return _.isObject(b)?a[c]:a},b);if(_.isNumber(d)||_.isBoolean(d))return e===d;if(_.isString(d))return e===a(d,b);if(_.isObject(d))return _.every(_.pairs(d),function(f){switch(f[0]){case"$eq":return e===a(f[1],b);case"$gt":return e>a(f[1],b);case"$gte":return e>=a(f[1],b);case"$lt":return e<a(f[1],b);case"$lte":return e<=a(f[1],b);case"$in":return _.contains(a(f[1],b),e);case"$nin":return!_.contains(a(f[1],b),e);case"$ne":return e!==a(f[1],b);case"$regex":return _.isString(e)?!!f[1].test(e):!1;default:console.info("obj: ",b),console.info("value: ",e),console.info("key: ",c),console.info("conditions: ",d);var g="not supported condition "+f[0];throw Error(g)}});throw Error("not implemented")},c=function(b,c){var d=c._id,e=_.groupBy(b,function(b){return a(d,b)});return _.map(_.pairs(e),function(b){var d=b[0],e=b[1];return _.reduce(_.pairs(c),function(b,c){var d=c[0],f=c[1];if("_id"===d);else if(_.isObject(f)&&_.has(f,"$sum"))b[d]=_.reduce(e,function(b,c){var d=a(f.$sum,c)||0;return _.isNumber(d)&&(b+=d),b},0);else if(_.isObject(f)&&_.has(f,"$avg")){var g=0;b[d]=_.reduce(e,function(b,c){var d=a(f.$avg,c);return _.isNumber(d)&&(b+=d,g++),b},0)/g}else if(_.isObject(f)&&_.has(f,"$first"))b[d]=a(f.$first,_.first(e));else if(_.isObject(f)&&_.has(f,"$last"))b[d]=a(f.$last,_.last(e));else if(_.isObject(f)&&_.has(f,"$max")){var h=_.max(e,function(b){return a(f.$max,b)||0});b[d]=a(f.$max,h)}else if(_.isObject(f)&&_.has(f,"$min")){var i=_.min(e,function(b){return a(f.$min,b)||0});b[d]=a(f.$min,i)}else if(_.isObject(f)&&_.has(f,"$any"))b[d]=_.some(e,function(b){return a(f.$any,b)});else if(_.isObject(f)&&_.has(f,"$fn"))b[d]=f.$fn(e);else{if(!_.isObject(f)||!_.has(f,"$addToSet")){var j='Expression "'+JSON.stringify(f)+'" not supported for $group operation';throw Error(j)}b[d]=_.uniq(_.map(e,function(b){return a(f.$addToSet,b)}))}return b},{_id:d})})},d=function(b,c){var d=_.pairs(c);return _(b).map(function(b){return _.reduce(d,function(c,d){var e,f=d[1],g=d[0],h=g.split("."),i=_.last(h);return e=1===f||f===!0?a("$"+g,b):a(f,b),_(h).reduce(function(a,b){return a[b]=b===i?e:a[b]||{},a[b]},c),c},{})})},e=function(a,c){return _.isNumber(c)?_(a).filter(function(a){return b(a,"$",c)}):_(_.pairs(c)).reduce(function(a,c){var d=c[0],f=c[1];return"$and"===d?_(f).reduce(function(a,b){return _.intersection(a,e(a,b))},a):"$or"===d?_(f).reduce(function(b,c){return _.union(b,e(a,c))},[]):"$nor"===d?_(f).reduce(function(a,b){return _.difference(a,e(a,b))},a):_(a).filter(function(a){return b(a,d,f)})},a)};_.mixin({aggregate:function(a,b){var f=a||[];return _(b).each(function(a){var b=_.keys(a)[0];if(!b)throw Error("Invalid pipe : "+JSON.stringify(a));switch(b){case"$project":f=d(f,a[b]);break;case"$group":f=c(f,a[b]);break;case"$match":f=e(f,a[b]);break;case"$skip":f=_(f).rest(a.$skip);break;case"$limit":f=_(f).first(a.$limit);break;default:throw Error(b+" pipes are not supported (yet?)")}}),f}});var f;(function(){var a,b,c=[].slice;f=function(){var b,d,e,g,h,i=this;return b=1<=arguments.length?c.call(arguments,0):[],0===b.length?function(){var a;return a=1<=arguments.length?c.call(arguments,0):[],f.apply(i,a)}:(e=0,d=g=!1,this.replace(/([{}])\1|[{](.*?)(?:!(.+?))?[}]/g,function(c,i,j,k){var l,m,n,o,p;if(i)return i;if(j.length){if(d=!0,g)throw new Error("cannot switch from {implicit} to {explicit} numbering");m=null!=(n=a(b,j))?n:""}else{if(g=!0,d)throw new Error(h("explicit","implicit"));m=null!=(o=b[e++])?o:""}return m=m.toString(),(l=f.transformers[k])?null!=(p=l.call(m))?p:"":m}))},a=function(a,c){var d;for(/^(\d+)([.]|$)/.test(c)||(c="0."+c);d=/(.+?)[.](.+)/.exec(c);)a=b(a,d[1]),c=d[2];return b(a,c)},b=function(a,b){var c;return c=a[b],"function"==typeof c?c.call(a):c},f.transformers={},f.version="0.2.1"}).call(this)}).call(this);