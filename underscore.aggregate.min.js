/* 
underscore.aggregate#1.3.1 
Copyright (C) Nicolas Panel 2014 
MIT license 
*/ 
"use strict";(function(){_.mixin({aggregate:function(a,b){var c=a||[];return _(b).each(function(a){var b=_.keys(a)[0];if(!b)throw Error("Invalid pipe : "+JSON.stringify(a));switch(b){case"$project":case"$map":c=f(c,a[b]);break;case"$group":c=e(c,a[b]);break;case"$match":case"$filter":case"$where":c=g(c,a[b]);break;case"$sort":case"$order":case"$sortBy":case"$orderBy":c=h(c,a[b]);break;case"$skip":c=_(c).rest(a.$skip);break;case"$limit":c=_(c).first(a.$limit);break;case"$objectify":return void(c=i(c,a[b]));default:throw Error(b+" pipes are not supported (yet?)")}}),c},$group:function(a,b){return _(e(a,b))},$match:function(a,b){return _(g(a,b))},$filter:function(a,b){return _(g(a,b))},$where:function(a,b){return _(g(a,b))},$objectify:function(a,b){return i(a,b)},$project:function(a,b){return _(f(a,b))},$map:function(a,b){return _(f(a,b))},$sort:function(a,b){return _(h(a,b))},$sortBy:function(a,b){return _(h(a,b))},$order:function(a,b){return _(h(a,b))},$orderBy:function(a,b){return _(h(a,b))}});var a,b=function(c,d){if(_.isString(c)&&"$"===c.charAt(0)){var e=c.substring(1);return""===e?d:_(e.split(".")).reduce(function(a,b){return a[b]},d)}if(_.isObject(c)){if(_.has(c,"$fn"))return c.$fn(d);if(_.has(c,"$literal"))return c.$literal;if(_.has(c,"$add"))return _(c.$add).reduce(function(a,c){return a+b(c,d)},0);if(_.has(c,"$divide"))return b(c.$divide[0],d)/b(c.$divide[1],d);if(_.has(c,"$mod"))return b(c.$mod[0],d)%b(c.$mod[1],d);if(_.has(c,"$multiply"))return _(c.$multiply).reduce(function(a,c){return a*b(c,d)},1);if(_.has(c,"$subtract"))return b(c.$subtract[0],d)-b(c.$subtract[1],d);if(_.has(c,"$eq"))return b(c.$eq[0],d)===b(c.$eq[1],d);if(_.has(c,"$ne"))return b(c.$ne[0],d)!==b(c.$ne[1],d);if(_.has(c,"$gt"))return b(c.$gt[0],d)>b(c.$gt[1],d);if(_.has(c,"$gte"))return b(c.$gte[0],d)>=b(c.$gte[1],d);if(_.has(c,"$lt"))return b(c.$lt[0],d)<b(c.$lt[1],d);if(_.has(c,"$lte"))return b(c.$lte[0],d)<=b(c.$lte[1],d);if(_.has(c,"$and"))return _(c.$and).every(function(a){return b(a,d)});if(_.has(c,"$or"))return _(c.$or).some(function(a){return b(a,d)});if(_.has(c,"$not"))return!b(c.$not,d);if(_.has(c,"$substr")){var f=b(c.$substr[0],d),g=b(c.$substr[1],d),h=b(c.$substr[2],d);return f.substr(g,h)}if(_.has(c,"$toLower"))return b(c.$toLower,d).toLowerCase();if(_.has(c,"$toUpper"))return b(c.$toUpper,d).toUpperCase();if(_.has(c,"$size"))return b(c.$size,d).length;if(_.has(c,"$dayOfMonth"))return b(c.$dayOfMonth,d).date();if(_.has(c,"$dayOfWeek"))return b(c.$dayOfWeek,d).weekday();if(_.has(c,"$dayOfYear"))return b(c.$dayOfYear,d).dayOfYear();if(_.has(c,"$hour"))return b(c.$hour,d).hour();if(_.has(c,"$millisecond"))return b(c.$millisecond,d).millisecond();if(_.has(c,"$minute"))return b(c.$minute,d).minute();if(_.has(c,"$month"))return b(c.$month,d).month();if(_.has(c,"$second"))return b(c.$second,d).second();if(_.has(c,"$week"))return b(c.$week,d).week();if(_.has(c,"$year"))return b(c.$year,d).year();if(_.has(c,"$valueOf"))return b(c.$valueOf,d).valueOf();if(_.has(c,"$diff")){var i=_(c.$diff).map(function(a){return b(a,d)});return-1*i[0].diff.apply(i[0],_.rest(i,1))}if(_.has(c,"$format")){var j=_.isArray(c.$format)?_(c.$format).map(function(a){return b(a,d)}):b(c.$format,d);return _.isString(j)?a.apply(j,[d]):1===j.length&&_.isString(j[0])?a.apply(j[0],[d]):_.isString(j[0])?a.apply(j[0],_.rest(j,1)):j[0].format(j[1])}return _.has(c,"$parse")?moment(b(c.$parse,d)):c}return c},c=function(a,c,d){switch(a){case"$sum":return _.reduce(d,function(a,d){var e=b(c,d)||0;return _.isNumber(e)&&(a+=e),a},0);case"$avg":var e=0;return _.reduce(d,function(a,d){var f=b(c,d);return _.isNumber(f)&&(a+=f,e++),a},0)/e;case"$first":return b(c,_.first(d));case"$last":return b(c,_.last(d));case"$max":return b(c,_.max(d,function(a){return b(c,a)||0}));case"$min":return b(c,_.min(d,function(a){return b(c,a)||0}));case"$any":return _.some(d,function(a){return b(c,a)});case"$fn":return c(d);case"$addToSet":return _.uniq(_.map(d,function(a){return b(c,a)}));default:var f='Accumulator "'+JSON.stringify(a)+'" not supported';throw Error(f)}},d=function(a,c,d){var e=_(c.split(".")).reduce(function(b,c){return _.isObject(a)?b[c]:b},a);if(_.isNumber(d)||_.isBoolean(d))return e===d;if(_.isString(d))return e===b(d,a);if(_.isObject(d))return _.every(_.pairs(d),function(f){switch(f[0]){case"$eq":return e===b(f[1],a);case"$gt":return e>b(f[1],a);case"$gte":return e>=b(f[1],a);case"$lt":return e<b(f[1],a);case"$lte":return e<=b(f[1],a);case"$in":return _.contains(b(f[1],a),e);case"$nin":return!_.contains(b(f[1],a),e);case"$ne":return e!==b(f[1],a);case"$regex":return _.isString(e)?!!f[1].test(e):!1;default:console.info("obj: ",a),console.info("value: ",e),console.info("key: ",c),console.info("conditions: ",d);var g="not supported condition "+f[0];throw Error(g)}});throw Error("not implemented")},e=function(a,d){var e=d._id,f=_.groupBy(a,function(a){return b(e,a)});return _.map(_.pairs(f),function(a){var b=a[0],e=a[1];return _.reduce(_.pairs(d),function(a,b){var d=b[0],f=b[1];if("_id"===d);else{if(!_.isObject(f)){var g='Expression "'+JSON.stringify(f)+'" not supported for $group operation';throw Error(g)}var h=_.keys(f)[0];a[d]=c(h,f[h],e)}return a},{_id:b})})},f=function(a,c){if(_.isString(c))return _(a).map(function(a){return b(c,a)});var d=_.pairs(c);return _(a).map(function(a){return _.reduce(d,function(c,d){var e,f=d[1],g=d[0],h=g.split("."),i=_.last(h);return e=1===f||f===!0?b("$"+g,a):b(f,a),_(h).reduce(function(a,b){return a[b]=b===i?e:a[b]||{},a[b]},c),c},{})})},g=function(a,b){return _.isNumber(b)?_(a).filter(function(a){return d(a,"$",b)}):_(_.pairs(b)).reduce(function(a,b){var c=b[0],e=b[1];return"$and"===c?_(e).reduce(function(a,b){return _.intersection(a,g(a,b))},a):"$or"===c?_(e).reduce(function(b,c){return _.union(b,g(a,c))},[]):"$nor"===c?_(e).reduce(function(a,b){return _.difference(a,g(a,b))},a):_(a).filter(function(a){return d(a,c,e)})},a)},h=function(a,c){return _(_.pairs(c)).reduce(function(c,d){var e="$"+d[0],f=-1===d[1],g=_(a).sortBy(function(a){return b(e,a)});return f?g.reverse():g},a)},i=function(a,c){var d=_.extend({_key:"$_id",_value:"$"},c||{});return _(a).reduce(function(a,c){var e=b(d._key,c);return a[e]=b(d._value,c),a},{})};(function(){var b,c,d=[].slice;a=function(){var c,e,f,g,h,i=this;return c=1<=arguments.length?d.call(arguments,0):[],0===c.length?function(){var b;return b=1<=arguments.length?d.call(arguments,0):[],a.apply(i,b)}:(f=0,e=g=!1,this.replace(/([{}])\1|[{](.*?)(?:!(.+?))?[}]/g,function(d,i,j,k){var l,m,n,o,p;if(i)return i;if(j.length){if(e=!0,g)throw new Error("cannot switch from {implicit} to {explicit} numbering");m=null!=(n=b(c,j))?n:""}else{if(g=!0,e)throw new Error(h("explicit","implicit"));m=null!=(o=c[f++])?o:""}return m=m.toString(),(l=a.transformers[k])?null!=(p=l.call(m))?p:"":m}))},b=function(a,b){var d;for(/^(\d+)([.]|$)/.test(b)||(b="0."+b);d=/(.+?)[.](.+)/.exec(b);)a=c(a,d[1]),b=d[2];return c(a,b)},c=function(a,b){var c;return c=a[b],"function"==typeof c?c.call(a):c},a.transformers={},a.version="0.2.1"}).call(this)}).call(this);